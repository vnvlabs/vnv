{% with strip = request.args.get("strip"), processor = request.args.get("processor","0")  %}

<div class="card">
    <div class="card-header">
        <h5>Realtime Chart</h5>
    </div>

    <div class="card-body">
        <div id="realtime-chart"></div>
    </div>

</div>

<script>

  $(function() {
            var lastDate = 0;
            var data = [];
            var ids = [];
            var pause = false;
            var running = false;
            var depth = {}
            var lastD = -1
            var overall = -1;
            var selectedNode = 0
                       barH = 50
            function totalHeight(depth) {
               r = depth*barH + 30
               return r.toString() + "px"
            }

            function getNewSeries(baseval, yrange) {

                var url = '{{url_for('base.files.viewers.next', id_=file.id_, count=10 )}}'
                $.get(  url , function(dd) {
                    overall = dd['endtime'];
                    var r = dd['data']
                    r.forEach(function (item, index) {

                       if ("restart" in item) {
                          data = []
                          depth = {}
                          lastD = -1;
                       }

                       // r => { "x" : xx, "y" : xx, "id" : xx, "done" : xx, "wait" : T/F }
                       del = []

                       // Did we step down
                       down = item.y < lastD
                       lastD = item.y
                       for (const [key, value] of Object.entries(depth)) {

                          if (item.y > key ) {

                              data[value].y[1] = item.x+1
                              if (data[value].endtime < 0 ) {
                                data[value].endtime = overall;
                              }
                          } else if (item.y == key ) {

                              if ( data[value].id === item.id || item.id < 0 ) {

                                 data[value].y[1] = item.x+1
                                 data[value].endtime = item.endtime

                              } else {

                                   data.push( {
                                     x : String(key) ,
                                     y : [ item.x, item.x+1 ],
                                     id : item.id,
                                     title: item.title,
                                     starttime : item.starttime,
                                     endtime : item.endtime,
                                     wait : item.wait
                                   })
                                   depth[key] = data.length - 1
                              }
                          } else {

                            del.push(key)

                          }
                       }
                       del.forEach(function(d,di) { delete depth[d]; })

                       if (! (item.y in depth) ) {
                             data.push( {
                                 x : String(item.y) ,
                                 y : [ item.x, item.x + 1 ],
                                 id : item.id,
                                 starttime : item.starttime,
                                 endtime : item.endtime,
                                 wait : item.wait,
                                 title: item.title
                              })
                              depth[item.y] = data.length - 1
                       }
                    });
                    if (r.length > 0 ) {
                        chart.updateSeries([{name: "Injection Point", data:data}])
                    }
                    if ( ( r.length == 0 || !("done" in r[r.length -1]) ) ){
                         chartInterval = window.setTimeout(getDataFromServer,3000)
                    }
                });
            }

            options = {
                series: [
                    {
                        name: "Injection Point",
                        data: []
                    }
                ],
                chart: {
                    type: "rangeBar",
                    events: {
                         dataPointSelection: function(event, chartContext, config) {
                               var url = '{{url_for('base.files.viewers.ip', id_=file.id_)}}'
                               url += "?ipid=" + data[config.dataPointIndex].id

                               $.get(  url , function( data ) {
                                  $('#{{injection_element}}').html(data)
                               });

                               selectedNode = config.dataPointIndex;
                               chart.updateOptions({})
                         }
                    },
                    height : totalHeight(3)
                },
                colors: [
                    function ({ value, seriesIndex, dataPointIndex, w }) {
                      return getColorAsScalar(dataPointIndex, dataPointIndex == selectedNode);
                    }
                ],
                tooltip: {
                    custom : function (opt) {
                        d = data[opt.dataPointIndex]
                        var url = '{{url_for('base.files.viewers.render_label', id_=file.id_)}}'
                        url += "?ipid=" + data[opt.dataPointIndex].id

                        var a = window.sessionStorage.getItem(url,data)
                        if (!a) {

                            $.get(  url , function( data ) {
                                window.sessionStorage.setItem(url,data)
                                $(`#tooltip-${opt.dataPointIndex}`).html(data)
                            });
                            return `<div id="tooltip-${opt.dataPointIndex}" class="label-container">
                                 Loading...
                            </div>`

                        } else {
                            return `<div id="tooltip-${opt.dataPointIndex}" class="label-container">
                                 ${a}
                             </div>`
                        }
                    },
                    fixed: {
                        enabled: false, position: "topLeft"
                    }
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        barHeight : barH.toString() + "px",
                        dataLabels: {
                           position: "top"
                        }
                    }
                },
                dataLabels : {
                   enabled : true,
                   formatter: function(val, opt) {
                      var x = data[opt.dataPointIndex]
                      return x.title + "  "
                   },
                   "textAnchor" : "end"
                },
                xaxis: {
                    type: "datetime",
                    "labels" : { "show" : false }
                }
            };

            var chart = new ApexCharts(document.querySelector("#realtime-chart"), options);
            chart.render();

            function getColorAsScalar(index, selected) {

                    var l = 50;
                    if (selected) { l = 80 }

                    var n = 240 * ( data[index].endtime - data[index].starttime ) / ( data[0].endtime - data[0].starttime )
                    return 'hsl(' + n + ', 100%, ' + l +'%)';
            }

            var dataPointsLength = 10;
            function getDataFromServer() {
                if (!pause) {
                  getNewSeries(lastDate, {
                     min: 10,
                     max: 90
                  })
                }
            }

            if (typeof variable !== 'undefined') {
               clearInterval(chartInterval)
            }
            getDataFromServer()

        });


</script>

{%endwith%}